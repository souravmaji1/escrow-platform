<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Upload and Download Tool for AWS Athena</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1386.0/aws-sdk.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            border-left-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-400 p-8 rounded-lg shadow-lg w-full max-w-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">CSV Upload and Download Tool for AWS Athena</h1>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Upload CSV</h2>
                <div class="flex items-center space-x-4">
                    <input type="file" id="fileInput" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="uploadButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">Upload and Process</button>
                </div>
            </div>

            <div id="downloadOptions" class="mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Download Options</h2>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <input type="number" id="rowsInput" min="1" value="10" class="block w-20 px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <button id="downloadButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">Download Rows</button>
                    </div>
                    <button id="downloadAllButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition duration-300">Download All Rows</button>
                </div>
            </div>

            <div id="result" class="text-center mb-4"></div>
            <div id="loader" class="hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Configure AWS SDK (You'll need to replace these with your actual AWS credentials)
        AWS.config.update({
            region: 'us-east-1',
            credentials: new AWS.Credentials('AKIAQ6FXL22LUYNQBI67', 'jKvPMSuuh0qvcdtT6GOzGxV+UuPwKbTFkWhZaoLf')
        });

        const athena = new AWS.Athena();
        const s3 = new AWS.S3();

        let csvContent = '';

        document.getElementById('uploadButton').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (file) {
                showLoader();
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvContent = e.target.result;
                    processCSV(csvContent);
                };
                reader.readAsText(file);
            } else {
                showError('Please select a CSV file.');
            }
        });

        function processCSV(csvContent) {
            // Parse CSV content
            const rows = csvContent.split('\n').map(row => row.split(','));
            const header = rows[0];
            const data = rows.slice(1);

            // Prepare the query to append data to Athena table
            const tableName = 'new_table';
            const query = `INSERT INTO ${tableName} (first_name, last_name, city, state)
                           VALUES ${data.map(row => {
                               // Trim whitespace and escape single quotes
                               const escapedRow = row.map(field => field.trim().replace(/'/g, "''"));
                               return `('${escapedRow[0]}', '${escapedRow[1]}', '${escapedRow[2]}', '${escapedRow[3]}')`;
                           }).join(', ')}`;

            // Execute Athena query
            const params = {
                QueryString: query,
                QueryExecutionContext: {
                    Database: 'consumer'
                },
                ResultConfiguration: {
                    OutputLocation: 's3://consumer-athena/query-output/'
                }
            };

            athena.startQueryExecution(params, function(err, data) {
                hideLoader();
                if (err) {
                    showError('Error uploading data: ' + err.message);
                } else {
                    showResult('Query submitted successfully. Execution ID: ' + data.QueryExecutionId);
                    // Enable download options
                    document.getElementById('downloadOptions').style.display = 'block';
                }
            });
        }

        document.getElementById('downloadButton').addEventListener('click', function() {
            const rows = document.getElementById('rowsInput').value;
            startDownload(rows);
        });

        document.getElementById('downloadAllButton').addEventListener('click', function() {
            startDownload('ALL');
        });

        function startDownload(rows) {
            showLoader();
            csvContent = '';
            const selectQuery = rows === 'ALL' 
                ? `SELECT * FROM master`
                : `SELECT * FROM master LIMIT ${rows}`;
            
            const params = {
                QueryString: selectQuery,
                QueryExecutionContext: {
                    Database: 'consumer'
                },
                ResultConfiguration: {
                    OutputLocation: 's3://consumer-athena/query-output/'
                }
            };

            athena.startQueryExecution(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error starting download query: ' + err.message);
                } else {
                    const queryExecutionId = data.QueryExecutionId;
                    checkQueryStatus(queryExecutionId, rows);
                }
            });
        }

        function checkQueryStatus(queryExecutionId, rows) {
            const params = {
                QueryExecutionId: queryExecutionId
            };

            athena.getQueryExecution(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error checking query status: ' + err.message);
                } else {
                    const status = data.QueryExecution.Status.State;
                    if (status === 'SUCCEEDED') {
                        getQueryResults(queryExecutionId, rows);
                    } else if (status === 'FAILED') {
                        hideLoader();
                        showError('Query failed: ' + data.QueryExecution.Status.StateChangeReason);
                    } else if (status === 'CANCELLED') {
                        hideLoader();
                        showError('Query was cancelled.');
                    } else {
                        // Query is still running, check again after a short delay
                        setTimeout(() => checkQueryStatus(queryExecutionId, rows), 1000);
                    }
                }
            });
        }

        function getQueryResults(queryExecutionId, rows, nextToken = null) {
            const params = {
                QueryExecutionId: queryExecutionId,
                MaxResults: 1000,
                NextToken: nextToken
            };

            athena.getQueryResults(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error getting query results: ' + err.message);
                } else {
                    processQueryResults(data, rows === 'ALL');
                    if (data.NextToken && rows === 'ALL') {
                        getQueryResults(queryExecutionId, rows, data.NextToken);
                    } else {
                        hideLoader();
                        downloadCsv(csvContent, `appended_data_${rows === 'ALL' ? 'all' : rows}_rows.csv`);
                        showResult('Download completed successfully.');
                    }
                }
            });
        }

        function processQueryResults(data, isAll) {
            if (csvContent === '') {
                const header = data.ResultSet.ResultSetMetadata.ColumnInfo.map(column => column.Name).join(',');
                csvContent = header + '\n';
            }
            
            const rows = data.ResultSet.Rows.slice(csvContent === '' ? 1 : 0);  // Skip header if it's the first batch
            csvContent += rows.map(row => row.Data.map(cell => cell.VarCharValue).join(',')).join('\n');
        }

        function downloadCsv(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('result').textContent = '';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showError(message) {
            const resultElement = document.getElementById('result');
            resultElement.textContent = message;
            resultElement.className = 'error';
        }

        function showResult(message) {
            const resultElement = document.getElementById('result');
            resultElement.textContent = message;
            resultElement.className = '';
        }
    </script>
</body>
</html>