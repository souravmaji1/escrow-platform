<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Enrichment Tool for AWS Athena</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1386.0/aws-sdk.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            border-left-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-400 p-8 rounded-lg shadow-lg w-full max-w-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">CSV Upload and Download Tool for AWS Athena</h1>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Upload CSV to Enrich</h2>
                <div class="flex items-center space-x-4">
                    <input type="file" id="fileInput" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="enrichButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">Upload</button>
                </div>
            </div>

            <div id="downloadOptions" class="mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Download Enriched Data</h2>
                <button id="downloadEnrichedButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">Download Enriched CSV</button>
            </div>

            <div id="result" class="text-center mb-4"></div>
            <div id="loader" class="hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Configure AWS SDK (You'll need to replace these with your actual AWS credentials)
        AWS.config.update({
            region: 'us-east-1',
            credentials: new AWS.Credentials('AKIAQ6FXL22LUYNQBI67', 'jKvPMSuuh0qvcdtT6GOzGxV+UuPwKbTFkWhZaoLf')
        });

        const athena = new AWS.Athena();
        const s3 = new AWS.S3();

        let enrichedData = '';
        let processedRows = new Set();

        document.getElementById('enrichButton').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (file) {
                showLoader();
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvContent = e.target.result;
                    processCSVForEnrichment(csvContent);
                };
                reader.readAsText(file);
            } else {
                showError('Please select a CSV file.');
            }
        });

        function processCSVForEnrichment(csvContent) {
            processedRows.clear();
            enrichedData = '';
            
            // Parse CSV content
            const rows = csvContent.split('\n').map(row => row.split(','));
            const header = rows[0];
            const data = rows.slice(1);

            // Prepare the query to enrich data
            const query = `
                SELECT DISTINCT m.*
                FROM master m
                JOIN (VALUES ${data.map(row => `('${row[0].trim()}', '${row[1].trim()}')`).join(', ')}) 
                    AS t (first_name, last_name)
                ON m.first_name = t.first_name AND m.last_name = t.last_name
            `;

            // Execute Athena query
            const params = {
                QueryString: query,
                QueryExecutionContext: {
                    Database: 'consumer'
                },
                ResultConfiguration: {
                    OutputLocation: 's3://consumer-athena/query-output/'
                }
            };

            athena.startQueryExecution(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error enriching data: ' + err.message);
                } else {
                    const queryExecutionId = data.QueryExecutionId;
                    checkQueryStatus(queryExecutionId);
                }
            });
        }

        function checkQueryStatus(queryExecutionId) {
            const params = {
                QueryExecutionId: queryExecutionId
            };

            athena.getQueryExecution(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error checking query status: ' + err.message);
                } else {
                    const status = data.QueryExecution.Status.State;
                    if (status === 'SUCCEEDED') {
                        getQueryResults(queryExecutionId);
                    } else if (status === 'FAILED') {
                        hideLoader();
                        showError('Query failed: ' + data.QueryExecution.Status.StateChangeReason);
                    } else if (status === 'CANCELLED') {
                        hideLoader();
                        showError('Query was cancelled.');
                    } else {
                        // Query is still running, check again after a short delay
                        setTimeout(() => checkQueryStatus(queryExecutionId), 1000);
                    }
                }
            });
        }

        function getQueryResults(queryExecutionId, nextToken = null) {
            const params = {
                QueryExecutionId: queryExecutionId,
                MaxResults: 1000,
                NextToken: nextToken
            };

            athena.getQueryResults(params, function(err, data) {
                if (err) {
                    hideLoader();
                    showError('Error getting query results: ' + err.message);
                } else {
                    processQueryResults(data);
                    if (data.NextToken) {
                        getQueryResults(queryExecutionId, data.NextToken);
                    } else {
                        hideLoader();
                        document.getElementById('downloadOptions').style.display = 'block';
                        showResult('Data enrichment completed. You can now download the enriched CSV.');
                    }
                }
            });
        }

        function processQueryResults(data) {
            if (enrichedData === '') {
                const header = data.ResultSet.ResultSetMetadata.ColumnInfo.map(column => column.Name).join(',');
                enrichedData = header + '\n';
            }
            
            const rows = data.ResultSet.Rows.slice(enrichedData === '' ? 1 : 0);
            rows.forEach(row => {
                const rowString = row.Data.map(cell => cell.VarCharValue).join(',');
                if (!processedRows.has(rowString)) {
                    enrichedData += rowString + '\n';
                    processedRows.add(rowString);
                }
            });
        }

        document.getElementById('downloadEnrichedButton').addEventListener('click', function() {
            downloadCsv(enrichedData, 'enriched_data.csv');
        });

        function downloadCsv(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('result').textContent = '';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showError(message) {
            const resultElement = document.getElementById('result');
            resultElement.textContent = message;
            resultElement.className = 'error';
        }

        function showResult(message) {
            const resultElement = document.getElementById('result');
            resultElement.textContent = message;
            resultElement.className = '';
        }
    </script>
</body>
</html>